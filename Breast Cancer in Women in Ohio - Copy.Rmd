---
title: "Associations between Socioeconomic Factors and Breast Cancer Incidence in Ohio Counties"
author: "Olivia Ling and Jojo Yu"
date: "November 28, 2025"
output:
  html_document:
    toc: true
    toc_float: true
  pdf_document: default
---

## 0. Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# IMPORTANT:
# Do NOT run install.packages() inside the Rmd.
# Instead, run this in the Console manually:
# install.packages(c("tidyverse","readxl","ggthemes","maps","mapdata","stringr","ggmap"))

library(tidyverse)
library(readxl)
library(ggthemes)
library(maps)
library(mapdata)
library(stringr)
library(ggmap)
```

## 1. Read & clean data

```{r read_clean}
county_df <- read_excel("County data.xlsx", skip = 4) |>
  dplyr::rename(
    county      = `County`,
    rural_urban = `Rural/Urban`,
    app_flag    = `...3`          # third column (Appalachian info)
  ) |>
  dplyr::filter(!is.na(county)) |>
  dplyr::mutate(
    county = stringr::str_trim(county),
    rural_urban = factor(
      rural_urban,
      levels = c("Urban", "Partially Rural County", "Rural")
    ),
    # app_flag column is "Appalachian County" or NA
    app_flag = if_else(
      is.na(app_flag),
      "Non-Appalachian",
      "Appalachian"
    ),
    app_flag = factor(app_flag, levels = c("Non-Appalachian","Appalachian"))
  )

glimpse(county_df)
```

## 2. Data Overview
```{r overview}
ru_summary <- county_df |>
dplyr::count(rural_urban) |>
dplyr::mutate(pct = round(100 * n / sum(n), 1))
ru_summary

app_summary <- county_df |>
dplyr::count(app_flag) |>
dplyr::mutate(pct = round(100 * n / sum(n), 1))
app_summary

cross_tab <- county_df |>
dplyr::count(app_flag, rural_urban) |>
dplyr::group_by(app_flag) |>
dplyr::mutate(pct_within_app = round(100 * n / sum(n), 1))
cross_tab

```

## 3. Read other sheets & merge

```{r read_merge}
# Each sheet: first column = County, second column = the variable we want.

# We use select(1, 3) so it doesn't matter what the original header text is.

poverty_df <- read_excel("County data.xlsx", sheet = "Poverty",   skip = 4) |>
dplyr::select(1, 3) |>
stats::setNames(c("county", "poverty_rate")) |>
dplyr::filter(!is.na(county)) |>
dplyr::mutate(county = stringr::str_trim(county))

income_df <- read_excel("County data.xlsx", sheet = "Income",    skip = 4) |>
dplyr::select(1, 3) |>
stats::setNames(c("county", "median_income")) |>
dplyr::filter(!is.na(county)) |>
dplyr::mutate(county = stringr::str_trim(county))

education_df <- read_excel("County data.xlsx", sheet = "Education", skip = 4) |>
dplyr::select(1, 3) |>
stats::setNames(c("county", "college_plus_pct")) |>
dplyr::filter(!is.na(county)) |>
dplyr::mutate(county = stringr::str_trim(county))

population_df <- read_excel("County data.xlsx", sheet = "Population", skip = 4) |>
dplyr::select(1, 3) |>
stats::setNames(c("county", "female_pop")) |>
dplyr::filter(!is.na(county)) |>
dplyr::mutate(county = stringr::str_trim(county))

cancer_df <- read_excel("County data.xlsx", sheet = "Cancer",   skip = 4) |>
dplyr::select(1, 2) |> # Changed from 3 to 2
stats::setNames(c("county", "cancer_incidence")) |>
dplyr::filter(!is.na(county)) |>
dplyr::mutate(county = stringr::str_trim(county))

# Merge everything into one master dataset

full_df <- county_df |>
dplyr::left_join(poverty_df,    by = "county") |>
dplyr::left_join(income_df,     by = "county") |> # Corrected from || to |>
dplyr::left_join(education_df,  by = "county") |>
dplyr::left_join(population_df, by = "county") |>
dplyr::left_join(cancer_df,     by = "county") |>
dplyr::mutate(
# make sure numeric types are correct
poverty_rate     = as.numeric(poverty_rate),
median_income    = as.numeric(gsub(",", "", median_income)),
college_plus_pct = as.numeric(college_plus_pct),
female_pop       = as.numeric(gsub(",", "", female_pop)),
cancer_incidence = as.numeric(cancer_incidence)
)

glimpse(full_df)

cancer_map <- cancer_df %>%
  dplyr::mutate(
    county = county %>%
      stringr::str_to_lower() %>%
      stringr::str_remove(" county$") %>%
      stringr::str_trim(),
    cancer_incidence = as.numeric(cancer_incidence)
  )

head(cancer_map)
```

## 4. Summarize

```{r summary}
#all data
summary(full_df)
```

## 5. Graphs: Cancer incidence vs predictors

### 5.1 Poverty Rate vs Cancer Incidence

```{r graphs}
ggplot(full_df, aes(x = poverty_rate, y = cancer_incidence)) +
geom_point(alpha = 0.7) +
geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
labs(
title = "Breast Cancer Incidence vs Poverty Rate",
x = "Poverty Rate (%)",
y = "Breast Cancer Incidence (per 100,000)"
) +
theme_minimal()
```

### 5.2 Median Household Income vs Cancer Incidence

```{r}
ggplot(full_df, aes(x = median_income, y = cancer_incidence)) +
geom_point(alpha = 0.7) +
geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
labs(
title = "Breast Cancer Incidence vs Median Household Income",
x = "Median Household Income ($)",
y = "Breast Cancer Incidence (per 100,000)"
) +
theme_minimal()
```

### 5.3 Educational Attainment (9th grade-) vs Cancer Incidence
```{r education}
ggplot(full_df, aes(x = college_plus_pct, y = cancer_incidence)) +
geom_point(alpha = 0.7) +
geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
labs(
title = "Breast Cancer Incidence vs % Adults With 9th grade education or less",
x = "Adults with 9th grade Degree or lower (%)",
y = "Breast Cancer Incidence (per 100,000)"
) +
theme_minimal()
```

### 5.4 Female Population (65+ or Total Female Population) vs Cancer Incidence
```{r female}
ggplot(full_df, aes(x = female_pop, y = cancer_incidence)) +
geom_point(alpha = 0.7) +
geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
labs(
title = "Female Population vs Breast Cancer Incidence",
x = "Female Population (Count or %)",
y = "Breast Cancer Incidence (per 100,000)"
) +
theme_minimal()
```

## 6. Create "High Incidence" Binary Variable
```{r incidence}
# Median cancer incidence across all counties

median_inc <- median(full_df$cancer_incidence, na.rm = TRUE)

full_df <- full_df %>%
mutate(
high_incidence = if_else(cancer_incidence > median_inc, 1L, 0L),
high_incidence = factor(high_incidence, levels = c(0, 1),
labels = c("Low", "High"))
)

# Check distribution

table(full_df$high_incidence)
```

## 7. Logistic Regression Model

### 7.1. Simple Logistic Regression (Unadjusted)
```{r logistic_regression_model}
model1 <- glm(
high_incidence ~ poverty_rate,
data = full_df,
family = binomial(link = "logit")
)

summary(model1)

## Odds ratios (Exponentiated Coefficients)

exp(coef(model1))

## 95% Confidence Intervals for ORs

exp(confint(model1))

# full-data
full_df %>%
  select(county, poverty_rate, median_income, college_plus_pct, female_pop) %>%
  head(10)


# Correration
cor(full_df[, c("poverty_rate", "median_income", "college_plus_pct", "female_pop")],
    use = "complete.obs")
```

### 7.2. Multivariable Logistic Regression Model
```{r multivariable}
model_full <- glm(
high_incidence ~ poverty_rate +
median_income +
college_plus_pct +
female_pop +
rural_urban +
app_flag,
data = full_df,
family = binomial(link = "logit")
)

summary(model_full)

## Odds ratios for the full model

exp(coef(model_full))

## 95% CI for the ORs

exp(confint(model_full))
```

## 8. Load datas
### 8.1. Load Ohio county polygons

```{r ohio_map}
ohio_map <- map_data("county") %>%
dplyr::filter(region == "ohio") %>%
dplyr::mutate(county = tolower(subregion))
```

### 8.2. Load Poverty data from County data.xlsx
```{r}
## (sheet named exactly "Poverty"; header row is 4, so skip = 4)

poverty <- read_excel(
  "County data.xlsx",
  sheet = "Poverty",
  skip = 4   # THIS is the correct skip
) %>%
  transmute(
    county = stringr::str_to_lower(stringr::str_remove(County, " County$")),
    poverty_pct = as.numeric(`Value (Percent)`)
  )

# quick checks (printed in knitted doc)
head(poverty)
head(ohio_map)
```

### 8.3. Prep other predictors for mapping

```{r map_predictors_prep}
income_map <- income_df %>%
  dplyr::mutate(
    county = county %>%
      stringr::str_to_lower() %>%
      stringr::str_remove(" county$") %>%
      stringr::str_trim()
  )

education_map <- education_df %>%
  dplyr::mutate(
    county = county %>%
      stringr::str_to_lower() %>%
      stringr::str_remove(" county$") %>%
      stringr::str_trim()
  )

population_map <- population_df %>%
  dplyr::mutate(
    county = county %>%
      stringr::str_to_lower() %>%
      stringr::str_remove(" county$") %>%
      stringr::str_trim()
  )

head(education_map)
```

## 9. Merge map polygons with poverty data

```{r map_poverty}
rural_urban_df <- county_df %>%
  mutate(
    county = county %>%
      stringr::str_to_lower() %>%
      stringr::str_remove(" county$") %>%
      stringr::str_trim()
  ) %>%
  dplyr::select(county, rural_urban, app_flag)

map_df <- ohio_map %>%
  dplyr::left_join(poverty,    by = "county") %>%
  dplyr::left_join(income_map,     by = "county") %>%
  dplyr::left_join(education_map,  by = "county") %>%
  dplyr::left_join(population_map, by = "county") %>%
  dplyr::left_join(rural_urban_df, by = "county") %>%
  dplyr::left_join(cancer_map,     by = "county") %>%
  dplyr::arrange(order)

dplyr::glimpse(map_df)

#rural_urban data check
dplyr::glimpse(rural_urban_df)
```

## 10. Compute centroids for county labels
```{r county_labels}
centroids <- map_df %>%
dplyr::group_by(county) %>%
dplyr::summarise(
clong = mean(long, na.rm = TRUE),
clat = mean(lat, na.rm = TRUE),
.groups = "drop"
)
```

## 11. Maps: Cancer incidence vs predictors

### 11.1. heat map for poverty
```{r poverty_map}
ggplot() +
geom_polygon(
data = map_df,
aes(x = long, y = lat, group = group, fill = poverty_pct),
color = "black",
linewidth = 0.2
) +
coord_fixed(1.3) +
geom_text(
data = centroids,
aes(x = clong, y = clat, label = county),
size = 2.0,
color = "black"
) +
scale_fill_distiller(palette = "Spectral", direction = 1) +
labs(
title = "Family Poverty (%) by County in Ohio",
fill = "Poverty %"
) +
theme_void() +
theme(
legend.position = "top",
plot.title = element_text(hjust = 0.5)
)
```

### 11.2. heat map for income

```{r income_map}
ggplot() +
  geom_polygon(
    data = map_df,
    aes(x = long, y = lat, group = group, fill = median_income),
    color = "black",
    linewidth = 0.2
  ) +
  coord_fixed(1.3) +
  geom_text(
    data = centroids,
    aes(x = clong, y = clat, label = county),
    size = 2.0,
    color = "black"
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  labs(
    title = "Income by County in Ohio",
    fill = "Income"
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )
```

### 11.3. heat map for Education

```{r education_map}
ggplot() +
  geom_polygon(
    data = map_df,
    aes(x = long, y = lat, group = group, fill = college_plus_pct),
    color = "black",
    linewidth = 0.2
  ) +
  coord_fixed(1.3) +
  geom_text(
    data = centroids,
    aes(x = clong, y = clat, label = county),
    size = 2.0,
    color = "black"
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  labs(
    title = "Percent with Bachelor's Degree or Higher by County in Ohio",
    fill = "College+ (%)"
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )
```

### 11.4. heat map for female population

```{r female_map}
ggplot() +
  geom_polygon(
    data = map_df,
    aes(x = long, y = lat, group = group, fill = female_pop),
    color = "black",
    linewidth = 0.2
  ) +
  coord_fixed(1.3) +
  geom_text(
    data = centroids,
    aes(x = clong, y = clat, label = county),
    size = 2.0,
    color = "black"
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  labs(
    title = "Female Population by County in Ohio",
    fill = "Female Pop"
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )
```

### 11.5. heat map for rural vs urban classification (categorical)

```{r rural_urban}
ggplot() +
  geom_polygon(
    data = map_df,
    aes(x = long, y = lat, group = group, fill = rural_urban),
    color = "black",
    linewidth = 0.2
  ) +
  coord_fixed(1.3) +
  geom_text(
    data = centroids,
    aes(x = clong, y = clat, label = county),
    size = 2.0,
    color = "black"
  ) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Rural / Urban Classification by County in Ohio",
    fill = "Rural/Urban"
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )
```

### 11.6 heat map for cancer incidence rate

```{r}
ggplot() +
  geom_polygon(
    data = map_df,
    aes(x = long, y = lat, group = group, fill = cancer_incidence),
    color = "black",
    linewidth = 0.2
  ) +
  coord_fixed(1.3) +
  geom_text(
    data = centroids,
    aes(x = clong, y = clat, label = county),
    size = 2.0,
    color = "black"
  ) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  labs(
    title = "Breast Cancer Incidence per 100,000 Women (Ohio)",
    fill = "Incidence"
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5)
  )
```